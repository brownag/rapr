---
title: "Accessing Rangeland Analysis Platform (RAP) Gridded Products with R"

output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Accessing Rangeland Analysis Platform (RAP) Gridded Products with R}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(rapr)
library(terra)   # spatial data handling
```

First we buffer 100m around a longitude/latitude coordinate (WGS84 decimal degrees) using the {terra} package.

You could change the coordinates to where you live or your favorite range spot! Change the buffering distance to include larger areas around a specified longitude/latitude point.

```{r} 
p <- buffer(terra::vect(
  data.frame(x = -105.97133, y = 32.73437),
  geom = c("x", "y"),
  crs = "OGC:CRS84"
), width = 1000)
```

In this example the target polygon has a significant Urban land component associated with the highway and adjacent development. How much of the polygon is reflecting inter-annual variation in plant cover? 

There are several housing developments and some areas have been cleared for grazing. The natural condition is closed canopy mixed oak/conifer woodland.

```{r, fig.width = 7}
terra::plet(p, tiles = c("Esri.WorldImagery", "OpenTopoMap"))
```

Use {rapr} to download the Rangeland Analysis Platform "vegetation-biomass" product for 1986 to 2021 using the mapunit polygon `p` to define the target extent.

```{r}
rap <- get_rap(
  p,
  product = "vegetation-biomass",
  years = 1986:2024,
  progress = FALSE
)
```

Let's look at the first layer:

```{r}
plot(rap[[1]], main = names(rap)[1])
```

## Animated Plots

Now we will select just the `"annual forb and grass biomass"` layers, iterate over them and plot symbolizing with a common range `[0,500]` pounds per acre.

Using the {gifski} package `save_gif()` function we can easily create an animated graphic of the RAP predictions. 

We write this iteration into a function called `makeplot()` and use {gifski} to render an animated GIF file from the R plot graphics output in each year for a total of 36 layers.

```{r}
makeplot <- function() {
  lapply(grep("annual_forb_and_grass_biomass", names(rap)), function(i) {
    terra::plot(rap[[i]], 
                main = names(rap)[i], 
                range = c(0, 500), 
                cex.main = TRUE)
    terra::plot(p, type ="continuous", add = TRUE)
  })
}
```

```{r, eval=as.logical(Sys.getenv("R_RAPR_EXTENDED_EXAMPLES", unset=FALSE))}
library(gifski)  # create GIF from results

gifski::save_gif(makeplot(), 
                 gif_file = "annual_forb_and_grass_biomass.gif", 
                 delay = 0.5)
```
